<%
  env_name = ENV.fetch('ENV_NAME')
  cluster_name = "#{env_name}-pks-cluster-1"
  dns_zone_name = "#{env_name}-zone"
  dns_zone_dns_name = "#{env_name}.cf-app.com."
  dns_record_set_name  = "cluster-1.#{dns_zone_dns_name}"
%>

resource "google_compute_address" "pks-tcp" {
  name = "<%= cluster_name %>"
}

resource "google_compute_target_pool" "pks-tcp" {
  name = "<%= cluster_name %>"
}

resource "google_compute_forwarding_rule" "pks-tcp" {
  name        = "<%= cluster_name %>"
  target      = "${google_compute_target_pool.pks-tcp.self_link}"
  port_range  = "8443"
  ip_protocol = "TCP"
  ip_address  = "${google_compute_address.pks-tcp.address}"
}

resource "google_dns_record_set" "pks-tcp" {
  name  = "<%= dns_record_set_name %>"
  type  = "A"
  ttl   = 300

  managed_zone = "<%= dns_zone_name %>"

  rrdatas = ["${google_compute_address.pks-tcp.address}"]
}
